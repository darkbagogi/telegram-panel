{% extends "base.html" %}

{% block title %}Telegram Üye Çekme Kampanyaları{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card glass-card">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h2 class="mb-2">
                                <i class="fas fa-rocket text-primary me-2"></i>
                                Telegram Üye Çekme Kampanyaları
                            </h2>
                            <p class="text-muted mb-0">
                                Akıllı algoritma ile güvenli ve etkili üye transferi yapın
                            </p>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#newCampaignModal">
                                <i class="fas fa-plus me-2"></i>Yeni Kampanya
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stat-card bg-gradient-primary">
                <div class="card-body text-center text-white">
                    <i class="fas fa-play-circle fa-2x mb-2"></i>
                    <h4 id="activeCampaigns">0</h4>
                    <p class="mb-0">Aktif Kampanya</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-gradient-success">
                <div class="card-body text-center text-white">
                    <i class="fas fa-user-plus fa-2x mb-2"></i>
                    <h4 id="todayInvites">0</h4>
                    <p class="mb-0">Bugün Davet</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-gradient-info">
                <div class="card-body text-center text-white">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <h4 id="successRate">0%</h4>
                    <p class="mb-0">Başarı Oranı</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card stat-card bg-gradient-warning">
                <div class="card-body text-center text-white">
                    <i class="fas fa-users fa-2x mb-2"></i>
                    <h4 id="totalMembers">0</h4>
                    <p class="mb-0">Toplam Üye</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Campaign List -->
    <div class="row">
        <div class="col-12">
            <div class="card glass-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Kampanya Listesi
                    </h5>
                    <div class="d-flex gap-2">
                        <select class="form-select form-select-sm" id="statusFilter" onchange="filterCampaigns()">
                            <option value="">Tüm Durumlar</option>
                            <option value="pending">Beklemede</option>
                            <option value="running">Çalışıyor</option>
                            <option value="paused">Duraklatıldı</option>
                            <option value="completed">Tamamlandı</option>
                            <option value="failed">Başarısız</option>
                        </select>
                        <button class="btn btn-outline-primary btn-sm" onclick="refreshCampaigns()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="campaignsContainer">
                        <!-- Campaigns will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Campaign Modal -->
<div class="modal fade" id="newCampaignModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content glass-card">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-rocket text-primary me-2"></i>
                    Yeni Üye Çekme Kampanyası
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newCampaignForm">
                    <!-- Step 1: Basic Info -->
                    <div class="step active" id="step1">
                        <h6 class="mb-3">
                            <span class="badge bg-primary me-2">1</span>
                            Temel Bilgiler
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="campaignName" class="form-label">Kampanya Adı</label>
                                    <input type="text" class="form-control" id="campaignName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="campaignDescription" class="form-label">Açıklama</label>
                                    <input type="text" class="form-control" id="campaignDescription">
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="sourceGroup" class="form-label">Kaynak Grup</label>
                                    <select class="form-select" id="sourceGroup" required>
                                        <option value="">Grup seçin...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="targetGroup" class="form-label">Hedef Grup</label>
                                    <select class="form-select" id="targetGroup" required>
                                        <option value="">Grup seçin...</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Settings -->
                    <div class="step" id="step2">
                        <h6 class="mb-3">
                            <span class="badge bg-primary me-2">2</span>
                            Kampanya Ayarları
                        </h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="dailyLimit" class="form-label">Günlük Limit</label>
                                    <input type="number" class="form-control" id="dailyLimit" value="50" min="1" max="200">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="transferMode" class="form-label">Transfer Modu</label>
                                    <select class="form-select" id="transferMode" onchange="toggleScheduleSettings()">
                                        <option value="smart">Akıllı Transfer</option>
                                        <option value="bulk">Toplu Transfer</option>
                                        <option value="scheduled">Zamanlanmış</option>
                                        <option value="auto">Otomatik</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="priority" class="form-label">Öncelik</label>
                                    <select class="form-select" id="priority">
                                        <option value="normal">Normal</option>
                                        <option value="high">Yüksek</option>
                                        <option value="low">Düşük</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Schedule Settings -->
                        <div class="card mt-3" id="scheduleSettings" style="display: none;">
                            <div class="card-header">
                                <h6 class="mb-0">Zamanlama Ayarları</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="startDate" class="form-label">Başlangıç Tarihi</label>
                                            <input type="datetime-local" class="form-control" id="startDate">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="endDate" class="form-label">Bitiş Tarihi</label>
                                            <input type="datetime-local" class="form-control" id="endDate">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="workingHours" class="form-label">Çalışma Saatleri</label>
                                            <select class="form-select" id="workingHours">
                                                <option value="24/7">24/7 Sürekli</option>
                                                <option value="business">İş Saatleri (09:00-18:00)</option>
                                                <option value="evening">Akşam (18:00-23:00)</option>
                                                <option value="custom">Özel Saat Aralığı</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="intervalMinutes" class="form-label">Aralık (Dakika)</label>
                                            <input type="number" class="form-control" id="intervalMinutes" value="30" min="5" max="1440">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="batchSize" class="form-label">Toplu İşlem Boyutu</label>
                                            <input type="number" class="form-control" id="batchSize" value="10" min="1" max="50">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Filter Settings -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">Üye Filtreleme Ayarları</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="filterActive" checked>
                                            <label class="form-check-label" for="filterActive">
                                                Sadece aktif üyeler
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="filterPremium">
                                            <label class="form-check-label" for="filterPremium">
                                                Premium üyeler öncelikli
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="filterBots" checked>
                                            <label class="form-check-label" for="filterBots">
                                                Bot hesapları hariç tut
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="filterRecent">
                                            <label class="form-check-label" for="filterRecent">
                                                Son 30 gün aktif olanlar
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="filterVerified">
                                            <label class="form-check-label" for="filterVerified">
                                                Doğrulanmış hesaplar öncelikli
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="filterMinAge">
                                            <label class="form-check-label" for="filterMinAge">
                                                Minimum 30 günlük hesaplar
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Safety Settings -->
                        <div class="card mt-3">
                            <div class="card-header">
                                <h6 class="mb-0">Güvenlik Ayarları</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="maxFailures" class="form-label">Maksimum Hata Sayısı</label>
                                            <input type="number" class="form-control" id="maxFailures" value="5" min="1" max="20">
                                            <small class="text-muted">Bu sayıya ulaşıldığında kampanya otomatik durdurulur</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="cooldownMinutes" class="form-label">Soğuma Süresi (Dakika)</label>
                                            <input type="number" class="form-control" id="cooldownMinutes" value="60" min="10" max="1440">
                                            <small class="text-muted">Hatadan sonra bekleme süresi</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="autoStop" checked>
                                    <label class="form-check-label" for="autoStop">
                                        Şüpheli aktivite tespit edildiğinde otomatik durdur
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-outline-primary" id="prevStep" onclick="previousStep()" style="display: none;">
                    <i class="fas fa-arrow-left me-2"></i>Önceki
                </button>
                <button type="button" class="btn btn-primary" id="nextStep" onclick="nextStep()">
                    Sonraki <i class="fas fa-arrow-right ms-2"></i>
                </button>
                <button type="button" class="btn btn-success" id="createCampaign" onclick="createCampaign()" style="display: none;">
                    <i class="fas fa-rocket me-2"></i>Kampanya Oluştur
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Campaign Details Modal -->
<div class="modal fade" id="campaignDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content glass-card">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-line text-primary me-2"></i>
                    Kampanya Detayları
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="campaignDetailsContent">
                <!-- Campaign details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<style>
.stat-card {
    border: none;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.bg-gradient-success {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.bg-gradient-info {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

.bg-gradient-warning {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
}

.campaign-card {
    border: none;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    margin-bottom: 15px;
}

.campaign-card:hover {
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
    transform: translateY(-2px);
}

.status-badge {
    font-size: 0.8em;
    padding: 0.4em 0.8em;
    border-radius: 20px;
}

.progress-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: white;
}

.step {
    display: none;
}

.step.active {
    display: block;
}

.glass-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

/* Schedule Settings */
.schedule-section {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 20px;
    margin-top: 15px;
    display: none;
}

.schedule-section h6 {
    color: #4fc3f7;
    margin-bottom: 15px;
    font-weight: 600;
}

.time-range {
    display: flex;
    gap: 10px;
    align-items: center;
}

.time-range input {
    flex: 1;
}

/* Transfer Mode Indicators */
.transfer-mode {
    background: rgba(79, 195, 247, 0.2);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8em;
}

.next-run {
    background: rgba(255, 193, 7, 0.2);
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8em;
}

/* Status Badge Enhancements */
.status-scheduled {
    background: linear-gradient(135deg, #ff9800, #f57c00);
}

.status-auto {
    background: linear-gradient(135deg, #9c27b0, #7b1fa2);
}

/* Safety Settings */
.safety-section {
    background: rgba(244, 67, 54, 0.1);
    border: 1px solid rgba(244, 67, 54, 0.2);
    border-radius: 10px;
    padding: 20px;
    margin-top: 15px;
}

.safety-section h6 {
    color: #f44336;
    margin-bottom: 15px;
    font-weight: 600;
}

/* Enhanced Form Controls */
.form-control:focus {
    border-color: #4fc3f7;
    box-shadow: 0 0 0 0.2rem rgba(79, 195, 247, 0.25);
}

.form-select:focus {
    border-color: #4fc3f7;
    box-shadow: 0 0 0 0.2rem rgba(79, 195, 247, 0.25);
}

/* Campaign Card Enhancements */
.campaign-meta .meta-item {
    margin-right: 15px;
    margin-bottom: 5px;
}

.campaign-meta .meta-item i {
    margin-right: 5px;
    width: 12px;
    text-align: center;
}
</style>

<script>
let jwtToken = localStorage.getItem('jwt_token');
let currentStep = 1;

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadCampaigns();
    loadGroups();
    loadStats();
});

function loadCampaigns() {
    fetch('/api/campaigns', {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${jwtToken}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.campaigns) {
            displayCampaigns(data.campaigns);
        } else {
            // Fallback to mock data
            const mockCampaigns = [
                {
                    id: 1,
                    name: "Teknoloji Grubu Transfer",
                    description: "Teknoloji odaklı üyelerin transferi",
                    status: "running",
                    source_group: "Kaynak Teknoloji Grubu",
                    target_group: "Hedef Teknoloji Grubu",
                    progress_percentage: 65.5,
                    invited_members: 131,
                    total_members: 200,
                    successful_invites: 98,
                    failed_invites: 33,
                    daily_limit: 50,
                    transfer_mode: "manual",
                    created_at: "2024-01-15T10:30:00Z",
                    next_run: null
                },
                {
                    id: 2,
                    name: "Otomatik Kripto Para Topluluğu",
                    description: "Kripto para yatırımcıları otomatik transferi",
                    status: "running",
                    source_group: "Kripto Yatırımcıları",
                    target_group: "Premium Kripto Grubu",
                    progress_percentage: 45.0,
                    invited_members: 90,
                    total_members: 200,
                    successful_invites: 78,
                    failed_invites: 12,
                    daily_limit: 30,
                    transfer_mode: "auto",
                    created_at: "2024-01-10T14:20:00Z",
                    next_run: "14:30"
                },
                {
                    id: 3,
                    name: "Zamanlanmış E-ticaret Kampanyası",
                    description: "E-ticaret gruplarından girişimcileri belirli saatlerde ekle",
                    status: "scheduled",
                    source_group: "E-ticaret Türkiye",
                    target_group: "Startup Community",
                    progress_percentage: 23.0,
                    invited_members: 46,
                    total_members: 200,
                    successful_invites: 41,
                    failed_invites: 5,
                    daily_limit: 25,
                    transfer_mode: "scheduled",
                    created_at: "2024-01-12T09:15:00Z",
                    next_run: "16:00"
                },
                {
                    id: 4,
                    name: "Tamamlanmış Finans Kampanyası",
                    description: "Başarıyla tamamlanmış finans grubu transferi",
                    status: "completed",
                    source_group: "Finans Grubu",
                    target_group: "Yatırım Topluluğu",
                    progress_percentage: 100.0,
                    invited_members: 320,
                    total_members: 320,
                    successful_invites: 301,
                    failed_invites: 19,
                    daily_limit: 40,
                    transfer_mode: "manual",
                    created_at: "2024-01-05T11:00:00Z",
                    next_run: null
                }
            ];
            displayCampaigns(mockCampaigns);
        }
    })
    .catch(error => {
        console.error('Error loading campaigns:', error);
        showNotification('Kampanyalar yüklenirken hata oluştu', 'error');
    });
}

function displayCampaigns(campaigns) {
    const container = document.getElementById('campaignsContainer');
    
    if (campaigns.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-rocket fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Henüz kampanya oluşturulmamış</h5>
                <p class="text-muted">İlk kampanyanızı oluşturmak için "Yeni Kampanya" butonuna tıklayın</p>
            </div>
        `;
        return;
    }

    container.innerHTML = campaigns.map(campaign => `
        <div class="campaign-card card mb-3">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-1">
                        <div class="progress-circle bg-${getStatusColor(campaign.status)}">
                            ${Math.round(campaign.progress_percentage || 0)}%
                        </div>
                    </div>
                    <div class="col-md-3">
                        <h6 class="mb-1">
                            ${campaign.name}
                            <i class="fas ${getTransferModeIcon(campaign.transfer_mode)} ms-2 text-muted" 
                               title="${getTransferModeText(campaign.transfer_mode)}"></i>
                        </h6>
                        <small class="text-muted">${campaign.description || 'Açıklama yok'}</small>
                        ${campaign.next_run ? `
                            <div class="mt-1">
                                <small class="text-info">
                                    <i class="fas fa-clock"></i> Sonraki çalışma: ${campaign.next_run}
                                </small>
                            </div>
                        ` : ''}
                    </div>
                    <div class="col-md-2">
                        <span class="status-badge badge bg-${getStatusColor(campaign.status)}">
                            ${getStatusText(campaign.status)}
                        </span>
                        <div class="mt-1">
                            <small class="text-muted">${getTransferModeText(campaign.transfer_mode)}</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-center">
                            <strong>${campaign.invited_members || 0}</strong>
                            <br>
                            <small class="text-muted">/ ${campaign.total_members || 0}</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="text-center">
                            <span class="text-success">${campaign.successful_invites || 0}</span>
                            /
                            <span class="text-danger">${campaign.failed_invites || 0}</span>
                            <br>
                            <small class="text-muted">Başarılı/Başarısız</small>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" onclick="viewCampaignDetails(${campaign.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            ${campaign.status === 'running' ? 
                                `<button class="btn btn-sm btn-outline-warning" onclick="pauseCampaign(${campaign.id})">
                                    <i class="fas fa-pause"></i>
                                </button>` :
                                campaign.status === 'paused' || campaign.status === 'pending' ?
                                `<button class="btn btn-sm btn-outline-success" onclick="startCampaign(${campaign.id})">
                                    <i class="fas fa-play"></i>
                                </button>` : ''
                            }
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCampaign(${campaign.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-${getStatusColor(campaign.status)}" 
                                 style="width: ${campaign.progress_percentage || 0}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function getStatusColor(status) {
    const colors = {
        'pending': 'secondary',
        'running': 'primary',
        'paused': 'warning',
        'completed': 'success',
        'failed': 'danger'
    };
    return colors[status] || 'secondary';
}

function getStatusText(status) {
    const texts = {
        'pending': 'Beklemede',
        'running': 'Çalışıyor',
        'paused': 'Duraklatıldı',
        'completed': 'Tamamlandı',
        'failed': 'Başarısız',
        'scheduled': 'Zamanlanmış'
    };
    return texts[status] || 'Bilinmiyor';
}

function getTransferModeIcon(mode) {
    const icons = {
        'smart': 'fa-brain',
        'bulk': 'fa-layer-group',
        'scheduled': 'fa-clock',
        'auto': 'fa-magic',
        'manual': 'fa-hand-pointer'
    };
    return icons[mode] || 'fa-cog';
}

function getTransferModeText(mode) {
    const texts = {
        'smart': 'Akıllı Transfer',
        'bulk': 'Toplu Transfer',
        'scheduled': 'Zamanlanmış',
        'auto': 'Otomatik',
        'manual': 'Manuel'
    };
    return texts[mode] || 'Bilinmiyor';
}

function loadGroups() {
    // Load groups for source and target selection
    fetch('/api/telegram/groups', {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${jwtToken}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.groups) {
            populateGroupSelects(data.groups);
        } else {
            // Mock data for groups
            const mockGroups = [
                { id: 1, name: "Teknoloji Grubu", member_count: 1250 },
                { id: 2, name: "Kripto Para Yatırımcıları", member_count: 890 },
                { id: 3, name: "Startup Girişimcileri", member_count: 650 }
            ];
            populateGroupSelects(mockGroups);
        }
    })
    .catch(error => {
        console.error('Error loading groups:', error);
    });
}

function populateGroupSelects(groups) {
    const sourceSelect = document.getElementById('sourceGroup');
    const targetSelect = document.getElementById('targetGroup');
    
    const groupOptions = groups.map(group => 
        `<option value="${group.id}">${group.name} (${group.member_count} üye)</option>`
    ).join('');
    
    sourceSelect.innerHTML = '<option value="">Grup seçin...</option>' + groupOptions;
    targetSelect.innerHTML = '<option value="">Grup seçin...</option>' + groupOptions;
}

function loadStats() {
    // Load campaign statistics
    const stats = {
        activeCampaigns: 2,
        todayInvites: 45,
        successRate: 75,
        totalMembers: 1250
    };
    
    document.getElementById('activeCampaigns').textContent = stats.activeCampaigns;
    document.getElementById('todayInvites').textContent = stats.todayInvites;
    document.getElementById('successRate').textContent = stats.successRate + '%';
    document.getElementById('totalMembers').textContent = stats.totalMembers;
}

function updateStatistics() {
    const activeCampaigns = allCampaigns.filter(c => c.status === 'running').length;
    const autoCampaigns = allCampaigns.filter(c => c.transfer_mode === 'auto' && c.status === 'running').length;
    const scheduledCampaigns = allCampaigns.filter(c => c.status === 'scheduled').length;
    const todayInvites = allCampaigns.reduce((sum, c) => sum + (c.invited_members || 0), 0);
    const totalInvites = allCampaigns.reduce((sum, c) => sum + (c.successful_invites || 0), 0);
    const avgSuccessRate = allCampaigns.length > 0 ? 
        Math.round(allCampaigns.reduce((sum, c) => {
            const rate = c.successful_invites && c.invited_members ? 
                (c.successful_invites / c.invited_members) * 100 : 0;
            return sum + rate;
        }, 0) / allCampaigns.length) : 0;
    
    document.getElementById('activeCampaigns').textContent = activeCampaigns;
    document.getElementById('todayInvites').textContent = todayInvites;
    document.getElementById('successRate').textContent = avgSuccessRate + '%';
    document.getElementById('totalMembers').textContent = totalInvites;
    
    // Update additional stats if elements exist
    const autoElement = document.getElementById('autoCampaigns');
    const scheduledElement = document.getElementById('scheduledCampaigns');
    
    if (autoElement) autoElement.textContent = autoCampaigns;
    if (scheduledElement) scheduledElement.textContent = scheduledCampaigns;
}

function nextStep() {
    if (currentStep < 2) {
        document.getElementById(`step${currentStep}`).classList.remove('active');
        currentStep++;
        document.getElementById(`step${currentStep}`).classList.add('active');
        
        document.getElementById('prevStep').style.display = 'inline-block';
        
        if (currentStep === 2) {
            document.getElementById('nextStep').style.display = 'none';
            document.getElementById('createCampaign').style.display = 'inline-block';
        }
    }
}

function previousStep() {
    if (currentStep > 1) {
        document.getElementById(`step${currentStep}`).classList.remove('active');
        currentStep--;
        document.getElementById(`step${currentStep}`).classList.add('active');
        
        if (currentStep === 1) {
            document.getElementById('prevStep').style.display = 'none';
        }
        
        document.getElementById('nextStep').style.display = 'inline-block';
        document.getElementById('createCampaign').style.display = 'none';
    }
}

function toggleScheduleSettings() {
    const transferMode = document.getElementById('transferMode').value;
    const scheduleSettings = document.getElementById('scheduleSettings');
    
    if (transferMode === 'scheduled' || transferMode === 'auto') {
        scheduleSettings.style.display = 'block';
    } else {
        scheduleSettings.style.display = 'none';
    }
}

function createCampaign() {
    const formData = {
        name: document.getElementById('campaignName').value,
        description: document.getElementById('campaignDescription').value,
        source_group: document.getElementById('sourceGroup').value,
        target_group: document.getElementById('targetGroup').value,
        daily_limit: document.getElementById('dailyLimit').value,
        transfer_mode: document.getElementById('transferMode').value,
        priority: document.getElementById('priority').value,
        schedule_settings: {
            start_date: document.getElementById('startDate').value,
            end_date: document.getElementById('endDate').value,
            working_hours: document.getElementById('workingHours').value,
            interval_minutes: document.getElementById('intervalMinutes').value,
            batch_size: document.getElementById('batchSize').value
        },
        filter_settings: {
            active_only: document.getElementById('filterActive').checked,
            premium_priority: document.getElementById('filterPremium').checked,
            exclude_bots: document.getElementById('filterBots').checked,
            recent_activity: document.getElementById('filterRecent').checked,
            verified_priority: document.getElementById('filterVerified').checked,
            min_age_days: document.getElementById('filterMinAge').checked ? 30 : 0
        },
        safety_settings: {
            max_failures: document.getElementById('maxFailures').value,
            cooldown_minutes: document.getElementById('cooldownMinutes').value,
            auto_stop: document.getElementById('autoStop').checked
        }
    };

    fetch('/api/campaigns', {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${jwtToken}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Kampanya başarıyla oluşturuldu!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('newCampaignModal')).hide();
            loadCampaigns();
            resetForm();
        } else {
            showNotification(data.message || 'Kampanya oluşturulurken hata oluştu', 'error');
        }
    })
    .catch(error => {
        console.error('Error creating campaign:', error);
        showNotification('Kampanya oluşturulurken hata oluştu', 'error');
    });
}

function resetForm() {
    document.getElementById('newCampaignForm').reset();
    currentStep = 1;
    document.getElementById('step1').classList.add('active');
    document.getElementById('step2').classList.remove('active');
    document.getElementById('prevStep').style.display = 'none';
    document.getElementById('nextStep').style.display = 'inline-block';
    document.getElementById('createCampaign').style.display = 'none';
}

function startCampaign(campaignId) {
    fetch(`/api/telegram/campaigns/${campaignId}/start`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${jwtToken}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Kampanya başlatıldı!', 'success');
            loadCampaigns();
        } else {
            showNotification(data.message || 'Kampanya başlatılırken hata oluştu', 'error');
        }
    })
    .catch(error => {
        console.error('Error starting campaign:', error);
        showNotification('Kampanya başlatılırken hata oluştu', 'error');
    });
}

function pauseCampaign(campaignId) {
    fetch(`/api/telegram/campaigns/${campaignId}/stop`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${jwtToken}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Kampanya duraklatıldı!', 'success');
            loadCampaigns();
        } else {
            showNotification(data.message || 'Kampanya duraklatılırken hata oluştu', 'error');
        }
    })
    .catch(error => {
        console.error('Error pausing campaign:', error);
        showNotification('Kampanya duraklatılırken hata oluştu', 'error');
    });
}

function deleteCampaign(campaignId) {
    if (confirm('Bu kampanyayı silmek istediğinizden emin misiniz?')) {
        fetch(`/api/campaigns/${campaignId}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${jwtToken}`,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification('Kampanya silindi!', 'success');
                loadCampaigns();
            } else {
                showNotification(data.message || 'Kampanya silinirken hata oluştu', 'error');
            }
        })
        .catch(error => {
            console.error('Error deleting campaign:', error);
            showNotification('Kampanya silinirken hata oluştu', 'error');
        });
    }
}

function viewCampaignDetails(campaignId) {
    fetch(`/api/campaigns/${campaignId}`, {
        method: 'GET',
        headers: {
            'Authorization': `Bearer ${jwtToken}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.campaign) {
            displayCampaignDetails(data.campaign);
        }
    })
    .catch(error => {
        console.error('Error loading campaign details:', error);
        showNotification('Kampanya detayları yüklenirken hata oluştu', 'error');
    });
}

function displayCampaignDetails(campaign) {
    const content = document.getElementById('campaignDetailsContent');
    content.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <h6>Genel Bilgiler</h6>
                <table class="table table-sm">
                    <tr><td><strong>Kampanya Adı:</strong></td><td>${campaign.name}</td></tr>
                    <tr><td><strong>Durum:</strong></td><td><span class="badge bg-${getStatusColor(campaign.status)}">${getStatusText(campaign.status)}</span></td></tr>
                    <tr><td><strong>Kaynak Grup:</strong></td><td>${campaign.source_group}</td></tr>
                    <tr><td><strong>Hedef Grup:</strong></td><td>${campaign.target_group}</td></tr>
                    <tr><td><strong>Günlük Limit:</strong></td><td>${campaign.daily_limit}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>İstatistikler</h6>
                <table class="table table-sm">
                    <tr><td><strong>Toplam Üye:</strong></td><td>${campaign.total_members || 0}</td></tr>
                    <tr><td><strong>Davet Edilen:</strong></td><td>${campaign.invited_members || 0}</td></tr>
                    <tr><td><strong>Başarılı:</strong></td><td class="text-success">${campaign.successful_invites || 0}</td></tr>
                    <tr><td><strong>Başarısız:</strong></td><td class="text-danger">${campaign.failed_invites || 0}</td></tr>
                    <tr><td><strong>İlerleme:</strong></td><td>${Math.round(campaign.progress_percentage || 0)}%</td></tr>
                </table>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <h6>İlerleme</h6>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar bg-${getStatusColor(campaign.status)}" 
                         style="width: ${campaign.progress_percentage || 0}%">
                        ${Math.round(campaign.progress_percentage || 0)}%
                    </div>
                </div>
            </div>
        </div>
    `;
    
    new bootstrap.Modal(document.getElementById('campaignDetailsModal')).show();
}

function filterCampaigns() {
    const status = document.getElementById('statusFilter').value;
    loadCampaigns(); // In a real implementation, this would filter by status
}

function refreshCampaigns() {
    loadCampaigns();
    showNotification('Kampanyalar yenilendi', 'info');
}

function showNotification(message, type) {
    // Simple notification system
    const alertClass = type === 'error' ? 'alert-danger' : 
                      type === 'success' ? 'alert-success' : 
                      type === 'info' ? 'alert-info' : 'alert-primary';
    
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 5000);
}
</script>
{% endblock %}