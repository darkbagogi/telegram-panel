{% extends "base.html" %}

{% block title %}Analytics - Telegram Premium Panel{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-chart-line me-2"></i>Analytics Dashboard</h2>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary active" data-period="7">7 Gün</button>
                    <button type="button" class="btn btn-outline-primary" data-period="30">30 Gün</button>
                    <button type="button" class="btn btn-outline-primary" data-period="90">90 Gün</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Özet İstatistikler -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="stat-card stat-card-success">
                <div class="stat-icon">
                    <i class="fas fa-user-plus"></i>
                </div>
                <div class="stat-content">
                    <h3 id="total-invites">0</h3>
                    <p>Toplam Davet</p>
                    <small class="text-success">
                        <i class="fas fa-arrow-up"></i>
                        <span id="invites-growth">0%</span> bu dönem
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card stat-card-info">
                <div class="stat-icon">
                    <i class="fas fa-percentage"></i>
                </div>
                <div class="stat-content">
                    <h3 id="success-rate">0%</h3>
                    <p>Başarı Oranı</p>
                    <small class="text-info">
                        <i class="fas fa-chart-line"></i>
                        <span id="success-trend">Stabil</span>
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card stat-card-warning">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <h3 id="avg-time">0s</h3>
                    <p>Ortalama Süre</p>
                    <small class="text-warning">
                        <i class="fas fa-stopwatch"></i>
                        Davet başına
                    </small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-content">
                    <h3 id="active-campaigns">0</h3>
                    <p>Aktif Kampanya</p>
                    <small class="text-muted">
                        <i class="fas fa-play"></i>
                        Şu anda çalışıyor
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Grafikler -->
    <div class="row mb-4">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-area me-2"></i>Davet Performansı
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="inviteChart" height="100"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Başarı Dağılımı
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="successChart" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Detaylı Analiz -->
    <div class="row mb-4">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>Hata Analizi
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Hata Türü</th>
                                    <th>Sayı</th>
                                    <th>Oran</th>
                                </tr>
                            </thead>
                            <tbody id="error-analysis">
                                <tr>
                                    <td colspan="3" class="text-center text-muted">
                                        <i class="fas fa-spinner fa-spin me-2"></i>Yükleniyor...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clock me-2"></i>Zaman Analizi
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">En Aktif Saatler</label>
                        <canvas id="hourlyChart" height="150"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Kampanya Performansı -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-trophy me-2"></i>En İyi Performans Gösteren Kampanyalar
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="exportReport()">
                        <i class="fas fa-download me-1"></i>Rapor İndir
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Kampanya Adı</th>
                                    <th>Toplam Davet</th>
                                    <th>Başarılı</th>
                                    <th>Başarı Oranı</th>
                                    <th>Ortalama Süre</th>
                                    <th>Durum</th>
                                </tr>
                            </thead>
                            <tbody id="top-campaigns">
                                <tr>
                                    <td colspan="6" class="text-center text-muted">
                                        <i class="fas fa-spinner fa-spin me-2"></i>Yükleniyor...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Rapor İndir</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="exportForm">
                    <div class="mb-3">
                        <label class="form-label">Rapor Türü</label>
                        <select class="form-select" name="report_type">
                            <option value="summary">Özet Rapor</option>
                            <option value="detailed">Detaylı Rapor</option>
                            <option value="campaigns">Kampanya Raporu</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Format</label>
                        <select class="form-select" name="format">
                            <option value="pdf">PDF</option>
                            <option value="excel">Excel</option>
                            <option value="csv">CSV</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tarih Aralığı</label>
                        <div class="row">
                            <div class="col-6">
                                <input type="date" class="form-control" name="start_date">
                            </div>
                            <div class="col-6">
                                <input type="date" class="form-control" name="end_date">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <button type="button" class="btn btn-primary" onclick="downloadReport()">
                    <i class="fas fa-download me-1"></i>İndir
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentPeriod = 7;
let charts = {};

// Sayfa yüklendiğinde
document.addEventListener('DOMContentLoaded', function() {
    loadAnalytics();
    initializeCharts();
    
    // Dönem butonları
    document.querySelectorAll('[data-period]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('[data-period]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentPeriod = parseInt(this.dataset.period);
            loadAnalytics();
        });
    });
    
    // Otomatik yenileme (5 dakikada bir)
    setInterval(loadAnalytics, 300000);
});

// Analytics verilerini yükle
function loadAnalytics() {
    fetch(`/api/analytics?period=${currentPeriod}`)
        .then(response => response.json())
        .then(data => {
            updateStats(data.stats);
            updateCharts(data.charts);
            updateErrorAnalysis(data.errors);
            updateTopCampaigns(data.campaigns);
        })
        .catch(error => {
            console.error('Analytics yüklenirken hata:', error);
            showNotification('Analytics verileri yüklenirken hata oluştu', 'error');
        });
}

// İstatistikleri güncelle
function updateStats(stats) {
    document.getElementById('total-invites').textContent = stats.total_invites.toLocaleString();
    document.getElementById('success-rate').textContent = stats.success_rate + '%';
    document.getElementById('avg-time').textContent = stats.avg_time + 's';
    document.getElementById('active-campaigns').textContent = stats.active_campaigns;
    
    document.getElementById('invites-growth').textContent = stats.growth + '%';
    document.getElementById('success-trend').textContent = stats.trend;
}

// Grafikleri başlat
function initializeCharts() {
    // Davet performans grafiği
    const inviteCtx = document.getElementById('inviteChart').getContext('2d');
    charts.invite = new Chart(inviteCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Başarılı Davetler',
                data: [],
                borderColor: '#28a745',
                backgroundColor: 'rgba(40, 167, 69, 0.1)',
                tension: 0.4
            }, {
                label: 'Toplam Davetler',
                data: [],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // Başarı dağılım grafiği
    const successCtx = document.getElementById('successChart').getContext('2d');
    charts.success = new Chart(successCtx, {
        type: 'doughnut',
        data: {
            labels: ['Başarılı', 'Başarısız', 'Beklemede'],
            datasets: [{
                data: [0, 0, 0],
                backgroundColor: ['#28a745', '#dc3545', '#ffc107']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
    
    // Saatlik aktivite grafiği
    const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
    charts.hourly = new Chart(hourlyCtx, {
        type: 'bar',
        data: {
            labels: Array.from({length: 24}, (_, i) => i + ':00'),
            datasets: [{
                label: 'Davet Sayısı',
                data: new Array(24).fill(0),
                backgroundColor: '#007bff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// Grafikleri güncelle
function updateCharts(chartData) {
    // Davet grafiği
    charts.invite.data.labels = chartData.invite.labels;
    charts.invite.data.datasets[0].data = chartData.invite.successful;
    charts.invite.data.datasets[1].data = chartData.invite.total;
    charts.invite.update();
    
    // Başarı grafiği
    charts.success.data.datasets[0].data = chartData.success;
    charts.success.update();
    
    // Saatlik grafik
    charts.hourly.data.datasets[0].data = chartData.hourly;
    charts.hourly.update();
}

// Hata analizini güncelle
function updateErrorAnalysis(errors) {
    const tbody = document.getElementById('error-analysis');
    tbody.innerHTML = '';
    
    if (errors.length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Hata bulunamadı</td></tr>';
        return;
    }
    
    errors.forEach(error => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${error.type}</td>
            <td><span class="badge bg-danger">${error.count}</span></td>
            <td>${error.percentage}%</td>
        `;
        tbody.appendChild(row);
    });
}

// En iyi kampanyaları güncelle
function updateTopCampaigns(campaigns) {
    const tbody = document.getElementById('top-campaigns');
    tbody.innerHTML = '';
    
    if (campaigns.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Kampanya bulunamadı</td></tr>';
        return;
    }
    
    campaigns.forEach(campaign => {
        const row = document.createElement('tr');
        const statusClass = campaign.status === 'completed' ? 'success' : 
                           campaign.status === 'running' ? 'primary' : 'warning';
        
        row.innerHTML = `
            <td><strong>${campaign.name}</strong></td>
            <td>${campaign.total_invites}</td>
            <td>${campaign.successful_invites}</td>
            <td>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar bg-success" style="width: ${campaign.success_rate}%">
                        ${campaign.success_rate}%
                    </div>
                </div>
            </td>
            <td>${campaign.avg_time}s</td>
            <td><span class="badge bg-${statusClass}">${campaign.status}</span></td>
        `;
        tbody.appendChild(row);
    });
}

// Rapor indir
function exportReport() {
    const modal = new bootstrap.Modal(document.getElementById('exportModal'));
    modal.show();
}

function downloadReport() {
    const form = document.getElementById('exportForm');
    const formData = new FormData(form);
    
    // Form verilerini URL parametrelerine çevir
    const params = new URLSearchParams();
    for (let [key, value] of formData.entries()) {
        params.append(key, value);
    }
    
    // Raporu indir
    window.open(`/api/export-report?${params.toString()}`, '_blank');
    
    // Modal'ı kapat
    bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
}

// Bildirim göster
function showNotification(message, type = 'info') {
    const alertClass = type === 'error' ? 'alert-danger' : `alert-${type}`;
    const notification = document.createElement('div');
    notification.className = `alert ${alertClass} alert-dismissible fade show notification`;
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // 5 saniye sonra otomatik kapat
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}
</script>
{% endblock %}